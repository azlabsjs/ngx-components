<!-- main -->
<ng-container *ngIf="state && state.formGroup">
  <!-- before-->
  <ng-content select="[before]"></ng-content>
  <!--\ before-->

  <!-- inputs -->
  <ng-container
    *ngTemplateOutlet="
      recursiveTemplate;
      context: {
        group: state.formGroup,
        controls: state.form.controlConfigs,
        autoupload
      }
    "
  ></ng-container>
  <!--\ inputs -->

  <!-- after-->
  <ng-content select="[after]"></ng-content>
  <!--\ after-->

  <!-- submit -->
  <ng-content select="[submit]"></ng-content>
  <!--\ submit -->
</ng-container>
<!--\ main -->

<ng-template
  #recursiveTemplate
  let-controls="controls"
  let-group="group"
  let-autoupload="autoupload"
>
  <div class="input-row" *ngIf="!noGridLayout">
    <ng-container
      *ngTemplateOutlet="
        previewTemplate;
        context: { controls, group, autoupload }
      "
    ></ng-container>
  </div>
  <ng-container *ngIf="!!noGridLayout">
    <ng-container
      *ngTemplateOutlet="
        previewTemplate;
        context: { controls, group, autoupload }
      "
    ></ng-container>
  </ng-container>
  <ng-template
    #previewTemplate
    let-controls="controls"
    let-group="group"
    let-autoupload="autoupload"
  >
    <ng-container *ngFor="let value of controls | asInputs">
      <!-- INPUT GROUP -->
      <ng-container *ngIf="value | asInputGroup | hasChildren; else inputRef">
        <div
          [class]="noGridLayout ? 'ngx-form-no-grid' : value.containerClass"
          [hidden]="(value | isHidden) || (group | inarray : state.detached)"
        >
          <ng-container *ngIf="group?.get(value.name) as local">
            <ng-container
              *ngTemplateOutlet="
                label ?? labelRef;
                context: {
                  $implicit: value.label,
                  config: value,
                  control: group
                }
              "
            ></ng-container>
            <ng-template
              #labelRef
              let-label
              let-config="config"
              let-control="control"
            >
              <div
                [innerHTML]="config.label | ngxGroupHeader | safeHtml"
                [hidden]="
                  (config | isHidden) || (local | inarray : state.detached)
                "
              ></div>
            </ng-template>
            <!-- REPEATABLE INPUTS GROUP -->
            <ng-container *ngIf="value | repeatable; else inputGroupRef">
              <ngx-smart-form-array
                [detached]="state.detached"
                [class]="value.classes"
                [no-grid-layout]="noGridLayout"
                [formArray]="local"
                [controls]="
                  (value | asInputGroup).children || [] | inputConfigArray
                "
                [template]="template"
                [addGroupRef]="addTemplate"
                [name]="value.name"
                [autoupload]="autoupload"
                [hidden]="
                  (value | isHidden) || (local | inarray : state.detached)
                "
              >
              </ngx-smart-form-array>
            </ng-container>
            <!--\ REPEATABLE INPUTS GROUP -->

            <!-- INPUTS GROUP -->
            <ng-template #inputGroupRef>
              <ng-container
                *ngTemplateOutlet="
                  recursiveTemplate;
                  context: {
                    controls: (value | asInputGroup)!.children || [],
                    group: local,
                    autoupload
                  }
                "
              ></ng-container>
            </ng-template>
            <!--\ INPUTS GROUP-->
          </ng-container>
        </div>
      </ng-container>
      <!--\ INPUT GROUP -->

      <!-- SIMPLE INPUT -->
      <ng-template #inputRef>
        <div
          [class]="noGridLayout ? 'ngx-form-no-grid' : value.containerClass"
          [hidden]="(value | isHidden) || (group | inarray : state.detached)"
        >
          <ng-container
            *ngTemplateOutlet="
              formTemplate;
              context: {
                value,
                group,
                autoupload
              }
            "
          ></ng-container>
        </div>
      </ng-template>
      <!--\ SIMPLE INPUT CONTAINER PART -->
    </ng-container>
  </ng-template>
</ng-template>

<ng-template #formTemplate let-group="group" let-value="value">
  <!-- REPEATABLE INPUTS -->
  <ng-container *ngIf="group?.get(value.name) as control">
    <ng-container *ngIf="value | repeatable; else notRepeatableRef">
      <ngx-smart-form-control-array
        [formArray]="control"
        [config]="value"
        [template]="template"
        [addButtonRef]="addTemplate"
        [name]="value.name"
        [autoupload]="autoupload"
        [hidden]="(value | isHidden) || (control | inarray : state.detached)"
        [detached]="state.detached"
      ></ngx-smart-form-control-array>
    </ng-container>

    <!-- NON REPEATABLE INPUTS -->
    <ng-template #notRepeatableRef>
      <ng-container
        *ngTemplateOutlet="
          template;
          context: {
            control,
            value,
            autoupload,
            template: { label },
            hidden: (value | isHidden) || (control | inarray : state.detached)
          }
        "
      >
      </ng-container>
    </ng-template>
    <!--\ NON REPEATABLE INPUTS -->
  </ng-container>
  <!--\ REPEATABLE INPUTS -->
</ng-template>
